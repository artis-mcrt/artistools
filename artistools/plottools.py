"""Matplotlib-related plotting functions."""

import argparse
import itertools
import sys
import typing as t
from collections.abc import Iterable

import matplotlib.axes as mplax
import matplotlib.figure as mplfig
import matplotlib.pyplot as plt
import numpy as np
import numpy.typing as npt
from matplotlib import ticker

from artistools.configuration import get_config

# colorcet.glasbey_category20
glasbey_category20 = [
    [0.121569, 0.466667, 0.705882],
    [1.0, 0.498039, 0.054902],
    [0.172549, 0.627451, 0.172549],
    [0.839216, 0.152941, 0.156863],
    [0.580392, 0.403922, 0.741176],
    [0.54902, 0.337255, 0.294118],
    [0.890196, 0.466667, 0.760784],
    [0.498039, 0.498039, 0.498039],
    [0.737255, 0.741176, 0.133333],
    [0.090196, 0.745098, 0.811765],
    [0.227451, 0.003922, 0.513725],
    [0.0, 0.262745, 0.003922],
    [0.058824, 1.0, 0.662745],
    [0.368627, 0.0, 0.25098],
    [0.737255, 0.737255, 1.0],
    [0.847059, 0.686275, 0.635294],
    [0.721569, 0.0, 0.501961],
    [0.0, 0.305882, 0.32549],
    [0.419608, 0.396078, 0.0],
    [0.490196, 0.007843, 0.0],
    [0.380392, 0.14902, 1.0],
    [1.0, 1.0, 0.603922],
    [0.341176, 0.286275, 0.392157],
    [0.54902, 0.721569, 0.580392],
    [0.580392, 0.988235, 1.0],
    [0.007843, 0.509804, 0.407843],
    [0.568627, 1.0, 0.0],
    [0.513725, 0.0, 0.627451],
    [0.678431, 0.537255, 0.266667],
    [0.356863, 0.203922, 0.0],
    [1.0, 0.752941, 0.952941],
    [1.0, 0.435294, 0.462745],
    [0.47451, 0.54902, 1.0],
    [0.866667, 0.0, 1.0],
    [0.317647, 0.337255, 0.27451],
    [0.0, 0.270588, 0.541176],
    [1.0, 0.74902, 0.376471],
    [1.0, 0.003922, 0.552941],
    [0.745098, 0.788235, 0.811765],
    [0.686275, 0.596078, 0.709804],
    [0.717647, 0.341176, 0.0],
    [0.007843, 0.439216, 0.0],
    [0.803922, 0.533333, 1.0],
    [0.113725, 0.839216, 0.27451],
    [0.752941, 0.92549, 0.768627],
    [0.478431, 0.596078, 0.709804],
    [0.647059, 0.376471, 0.537255],
    [0.435294, 0.537255, 0.341176],
    [0.741176, 0.490196, 0.462745],
    [0.545098, 0.160784, 0.270588],
    [0.0, 0.678431, 1.0],
    [0.560784, 0.831373, 1.0],
    [0.294118, 0.427451, 0.466667],
    [0.0, 0.831373, 0.694118],
    [0.576471, 0.0, 0.952941],
    [0.545098, 0.584314, 0.0],
    [0.364706, 0.360784, 0.623529],
    [0.996078, 0.87451, 0.733333],
    [0.0, 0.576471, 0.623529],
    [1.0, 0.862745, 0.0],
    [0.0, 0.670588, 0.47451],
    [0.321569, 0.0, 0.407843],
    [0.0, 0.0, 0.572549],
    [0.043137, 0.364706, 0.243137],
    [0.65098, 0.890196, 0.462745],
    [0.384314, 0.231373, 0.254902],
    [0.776471, 0.780392, 0.541176],
    [1.0, 0.619608, 0.713725],
    [0.807843, 0.313725, 0.423529],
    [1.0, 0.027451, 0.839216],
    [0.545098, 0.227451, 0.019608],
    [0.498039, 0.243137, 0.443137],
    [1.0, 0.286275, 0.007843],
    [0.376471, 0.172549, 0.65098],
    [0.109804, 0.0, 1.0],
    [0.905882, 0.87451, 1.0],
    [0.666667, 0.231373, 0.686275],
    [0.85098, 0.611765, 0.0],
    [0.639216, 0.639216, 0.623529],
    [0.247059, 0.415686, 1.0],
    [0.27451, 0.286275, 0.05098],
    [0.482353, 0.411765, 0.521569],
    [0.423529, 0.596078, 0.552941],
    [1.0, 0.603922, 0.458824],
    [0.517647, 0.360784, 1.0],
    [0.486275, 0.423529, 0.27451],
    [0.505882, 0.717647, 0.333333],
    [0.741176, 0.0, 0.290196],
    [0.992157, 0.580392, 1.0],
    [0.364706, 0.0, 0.094118],
    [0.541176, 0.819608, 0.819608],
    [0.615686, 0.552941, 0.827451],
    [0.854902, 0.427451, 0.262745],
    [0.545098, 0.345098, 0.0],
    [0.235294, 0.317647, 0.415686],
    [0.298039, 0.423529, 0.231373],
    [0.933333, 0.815686, 0.847059],
    [0.811765, 0.933333, 1.0],
    [0.666667, 0.082353, 0.0],
    [0.87451, 1.0, 0.309804],
    [1.0, 0.168627, 0.341176],
    [0.819608, 0.286275, 0.619608],
    [0.439216, 0.490196, 0.721569],
    [0.352941, 0.501961, 0.0],
    [0.0, 0.898039, 0.992157],
    [0.466667, 0.294118, 0.584314],
    [0.407843, 0.835294, 0.54902],
    [0.243137, 0.227451, 0.447059],
    [0.67451, 0.254902, 0.247059],
    [0.839216, 0.635294, 0.4],
    [0.756863, 0.411765, 0.807843],
    [0.415686, 0.34902, 0.368627],
    [0.533333, 0.67451, 0.929412],
    [0.627451, 0.65098, 0.415686],
    [0.823529, 0.666667, 0.901961],
    [0.533333, 0.0, 0.388235],
    [0.0, 0.992157, 0.858824],
    [0.407843, 0.156863, 0.098039],
    [0.705882, 0.258824, 1.0],
    [0.054902, 0.34902, 0.772549],
    [0.090196, 0.529412, 0.262745],
    [0.568627, 0.827451, 0.0],
    [0.807843, 0.47451, 0.0],
    [0.976471, 0.352941, 1.0],
    [0.356863, 0.454902, 0.4],
    [0.556863, 0.682353, 0.701961],
    [0.611765, 0.490196, 0.54902],
    [0.27451, 0.0, 0.776471],
    [0.423529, 0.305882, 0.180392],
    [0.65098, 0.427451, 0.27451],
    [0.619608, 0.537255, 0.45098],
    [0.658824, 0.686275, 0.792157],
    [0.807843, 0.552941, 0.654902],
    [0.0, 0.996078, 0.392157],
    [0.572549, 0.47451, 0.0],
    [1.0, 0.388235, 0.631373],
    [0.960784, 1.0, 0.847059],
    [0.003922, 0.54902, 0.945098],
    [0.078431, 0.67451, 0.627451],
    [0.356863, 0.180392, 0.352941],
    [0.537255, 0.52549, 0.619608],
    [0.815686, 0.8, 0.733333],
    [0.831373, 0.686275, 0.772549],
    [0.858824, 0.866667, 0.427451],
    [0.815686, 1.0, 0.956863],
    [0.0, 0.396078, 0.52549],
    [0.0, 0.411765, 0.388235],
    [0.658824, 0.254902, 0.407843],
    [0.176471, 0.592157, 0.772549],
    [0.662745, 0.454902, 1.0],
    [0.152941, 0.733333, 0.368627],
    [0.345098, 0.717647, 0.0],
    [0.796078, 1.0, 0.654902],
    [0.643137, 0.478431, 0.670588],
    [1.0, 0.741176, 0.580392],
    [0.537255, 0.886275, 0.756863],
    [0.058824, 0.788235, 1.0],
    [0.835294, 0.0, 0.772549],
    [0.388235, 0.427451, 0.541176],
    [0.411765, 0.521569, 0.560784],
    [0.294118, 0.305882, 0.32549],
    [0.670588, 0.376471, 0.407843],
    [0.478431, 0.713725, 0.835294],
    [0.172549, 0.352941, 0.090196],
    [0.603922, 0.0, 0.145098],
    [0.745098, 0.819608, 0.952941],
    [0.541176, 0.435294, 0.407843],
    [0.415686, 0.647059, 0.419608],
    [0.52549, 0.329412, 0.407843],
    [0.682353, 0.803922, 0.729412],
    [0.533333, 0.6, 0.498039],
    [0.796078, 0.862745, 0.0],
    [0.607843, 0.015686, 0.568627],
    [0.921569, 0.737255, 0.105882],
    [0.921569, 0.611765, 0.823529],
    [0.439216, 0.0, 0.435294],
    [0.694118, 0.631373, 0.196078],
    [0.792157, 0.423529, 0.576471],
    [0.254902, 0.27451, 0.643137],
    [0.898039, 0.54902, 0.541176],
    [0.835294, 0.270588, 0.0],
    [0.780392, 0.545098, 0.796078],
    [0.717647, 0.588235, 0.592157],
    [0.831373, 0.12549, 0.462745],
    [0.447059, 0.294118, 0.8],
    [0.407843, 0.305882, 0.0],
    [0.407843, 0.133333, 0.219608],
    [0.219608, 0.337255, 0.309804],
    [0.435294, 0.733333, 0.670588],
    [0.52549, 0.227451, 0.192157],
    [0.647059, 0.827451, 0.596078],
    [0.72549, 0.686275, 0.560784],
    [0.847059, 0.894118, 0.87451],
    [0.670588, 0.0, 0.878431],
    [0.796078, 0.756863, 0.858824],
    [1.0, 0.87451, 0.54902],
    [0.890196, 0.32549, 0.301961],
    [0.4, 0.411765, 0.435294],
    [1.0, 0.0, 0.109804],
    [0.32549, 0.176471, 0.45098],
    [0.305882, 0.568627, 0.423529],
    [0.658824, 0.427451, 0.066667],
    [1.0, 0.623529, 0.14902],
    [0.372549, 0.639216, 0.690196],
    [0.784314, 0.521569, 0.341176],
    [0.572549, 0.34902, 0.596078],
    [0.639216, 0.631373, 1.0],
    [0.996078, 0.729412, 0.729412],
    [0.145098, 0.164706, 0.533333],
    [0.858824, 0.901961, 0.658824],
    [0.592157, 0.94902, 0.654902],
    [0.403922, 0.580392, 0.839216],
    [0.729412, 0.356863, 0.25098],
    [0.227451, 0.364706, 0.572549],
    [0.211765, 0.309804, 0.184314],
    [0.152941, 0.486275, 0.588235],
    [0.541176, 0.584314, 0.607843],
    [0.815686, 0.705882, 0.341176],
    [0.0, 0.278431, 0.392157],
    [0.372549, 0.364706, 0.184314],
    [0.556863, 0.556863, 0.254902],
    [0.678431, 0.247059, 0.07451],
    [0.415686, 0.588235, 0.235294],
    [0.631373, 0.239216, 0.521569],
    [0.74902, 0.717647, 0.729412],
    [0.67451, 0.776471, 0.403922],
    [0.396078, 0.411765, 0.811765],
    [0.572549, 0.690196, 0.0],
    [0.172549, 0.890196, 0.854902],
    [0.003922, 0.435294, 0.211765],
    [1.0, 0.47451, 0.32549],
    [0.258824, 0.505882, 0.498039],
    [0.309804, 0.913725, 0.0],
    [0.6, 0.329412, 0.156863],
    [0.364706, 0.039216, 0.0],
    [0.639216, 0.0, 0.345098],
    [0.047059, 0.533333, 0.0],
    [0.352941, 0.513725, 0.654902],
    [1.0, 0.92549, 0.984314],
    [0.294118, 0.411765, 0.003922],
    [0.533333, 0.462745, 0.831373],
    [0.901961, 0.780392, 1.0],
    [0.647059, 1.0, 0.854902],
    [0.847059, 0.435294, 0.470588],
    [0.87451, 0.007843, 0.294118],
    [0.415686, 0.407843, 0.360784],
    [0.470588, 0.419608, 0.635294],
    [0.494118, 0.501961, 0.403922],
    [0.352941, 0.278431, 0.52549],
    [0.0, 0.0, 0.792157],
    [0.486275, 0.0, 0.168627],
    [0.592157, 1.0, 0.447059],
    [0.713725, 0.890196, 0.882353],
    [0.862745, 0.32549, 0.788235],
    [0.466667, 0.470588, 0.203922],
    [0.345098, 0.745098, 0.556863],
]


def set_mpl_style() -> None:
    plt.style.use("file://" + str(get_config()["path_artistools_dir"] / "matplotlibrc"))


class ExponentLabelFormatter(ticker.ScalarFormatter):
    """Formatter to move the 'x10^x' offset text into the axis label."""

    _useMathText: bool
    _usetex: bool

    def __init__(self, labeltemplate: str, useMathText: bool = True) -> None:
        self.set_labeltemplate(labeltemplate)

        super().__init__(useOffset=False, useMathText=useMathText)
        # ticker.ScalarFormatter.__init__(self, useOffset=useOffset, useMathText=useMathText)
        self.set_scientific(True)
        self.set_powerlimits((0, 0))  # always use scientific notation

    def _set_formatted_label_text(self) -> None:
        # or use self.orderOfMagnitude
        stroffset = self.get_offset()
        if stroffset:
            stroffset = stroffset.replace(r"$\times", "$") + " "
        strnewlabel = self.labeltemplate.format(stroffset)
        assert self.axis is not None
        self.axis.set_label_text(strnewlabel)  # type: ignore[union-attr] # pyright: ignore[reportAttributeAccessIssue]
        assert self.offset == 0
        self.axis.offsetText.set_visible(False)  # type: ignore[union-attr] # pyright: ignore[reportAttributeAccessIssue]

    def set_labeltemplate(self, labeltemplate: str) -> None:
        assert "{" in labeltemplate
        self.labeltemplate = labeltemplate

    def set_locs(self, locs) -> None:  # noqa: ANN001
        super().set_locs(locs)
        self._set_formatted_label_text()

    def set_axis(self, axis) -> None:  # noqa: ANN001
        super().set_axis(axis)
        self._set_formatted_label_text()


def set_axis_properties(ax: Iterable[mplax.Axes] | mplax.Axes, args: argparse.Namespace) -> t.Any:
    if "subplots" not in args:
        args.subplots = False
    if "labelfontsize" not in args:
        args.labelfontsize = 18

    if isinstance(ax, Iterable):
        for axis in ax:
            assert isinstance(axis, mplax.Axes)
            axis.minorticks_on()
            axis.tick_params(
                axis="both",
                which="minor",
                top=True,
                right=True,
                length=5,
                width=2,
                labelsize=args.labelfontsize,
                direction="in",
            )
            axis.tick_params(
                axis="both",
                which="major",
                top=True,
                right=True,
                length=8,
                width=2,
                labelsize=args.labelfontsize,
                direction="in",
            )

    else:
        ax.minorticks_on()
        ax.tick_params(
            axis="both",
            which="minor",
            top=True,
            right=True,
            length=5,
            width=2,
            labelsize=args.labelfontsize,
            direction="in",
        )
        ax.tick_params(
            axis="both",
            which="major",
            top=True,
            right=True,
            length=8,
            width=2,
            labelsize=args.labelfontsize,
            direction="in",
        )

    if "ymin" in args or "ymax" in args:
        plt.ylim(args.ymin, args.ymax)
    if "xmin" in args or "xmax" in args:
        plt.xlim(args.xmin, args.xmax)

    if getattr(args, "logscalex", False):
        plt.xscale("log")
    if getattr(args, "logscaley", False):
        plt.yscale("log")

    plt.minorticks_on()
    return ax


def set_axis_labels(
    fig: mplfig.Figure,
    ax: mplax.Axes | npt.ArrayLike,
    xlabel: str,
    ylabel: str,
    labelfontsize: int | None,
    args: argparse.Namespace,
) -> None:
    if args.subplots:
        fig.text(0.5, 0.02, xlabel, ha="center", va="center")
        fig.text(0.02, 0.5, ylabel, ha="center", va="center", rotation="vertical")
    else:
        assert isinstance(ax, mplax.Axes)
        ax.set_xlabel(xlabel, fontsize=labelfontsize)
        ax.set_ylabel(ylabel, fontsize=labelfontsize)


def imshow_init_for_artis_grid(
    ngrid: int, vmax: float, plot_variable_3d_array: npt.NDArray[t.Any], plot_axes: str = "xy"
) -> tuple[npt.NDArray[t.Any], tuple[float, float, float, float]]:
    # ngrid = round(len(model['inputcellid']) ** (1./3.))
    extentdict = {"left": -vmax, "right": vmax, "bottom": vmax, "top": -vmax}
    extent = extentdict["left"], extentdict["right"], extentdict["bottom"], extentdict["top"]
    data = np.zeros((ngrid, ngrid))

    plot_axes_choices = ["xy", "xz"]
    if plot_axes not in plot_axes_choices:
        print(f"Choose plot axes from {plot_axes_choices}")
        sys.exit(1)

    for z, y, x in itertools.product(range(ngrid), range(ngrid), range(ngrid)):
        if plot_axes == "xy":
            if z == round(ngrid / 2) - 1:
                data[y, x] = plot_variable_3d_array[x, y, z]
        elif plot_axes == "xz" and y == round(ngrid / 2) - 1:
            data[z, x] = plot_variable_3d_array[x, y, z]

    return data, extent
